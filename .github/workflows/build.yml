name: build

on:
    release:
        types: [ published ]

jobs:
    deploy:
        name: deploy to PyPi
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v2
            -   name: Install Python
                uses: actions/setup-python@v2
            -   name: Restore cached dependencies
                uses: actions/cache@v2
                with:
                    path: ~/.cache/pip
                    key: ${{ runner.os }}-pip-${{ runner.python-version }}-${{ hashFiles('setup.py') }}
                    restore-keys: ${{ runner.os }}-pip-${{ runner.python-version }}-
            -   name: Install dependencies
                run: pip install dunamai setuptools wheel twine
            -   name: Build package
                run: python setup.py sdist bdist_wheel
            -   name: Upload wheel
                uses: actions/upload-artifact@v2
                with:
                    name: dist
                    path: dist
            -   name: Publish package to PyPi
                env:
                    TWINE_USERNAME: __token__
                    TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
                run: twine upload dist/* --verbose
    install:
        name: install with Python ${{ matrix.python-version }} on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        needs: deploy
        strategy:
            matrix:
                os: [ ubuntu-latest, macos-latest, windows-latest ]
                python-version: [ 3.8 ]
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v2
            -   name: Install Python
                uses: actions/setup-python@v2
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Restore cached dependencies
                uses: actions/cache@v2
                with:
                    path: ~/.cache/pip
                    key: ${{ runner.os }}-pip-${{ runner.python-version }}-${{ hashFiles('setup.py') }}
                    restore-keys: ${{ runner.os }}-pip-${{ runner.python-version }}-
            -   name: Retrieve version from repository
                uses: mtkennerly/dunamai-action@v1
                with:
                    env-var: VERSION
            -   name: Wait several seconds for PyPI distribution to become available
                uses: jakejarvis/wait-action@v0.1.0
                with:
                    time: '10s'
            -   name: Install wheel
                run: pip install packetraven==$VERSION
                shell: bash
