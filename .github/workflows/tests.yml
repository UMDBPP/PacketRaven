name: tests

on: [ push ]

jobs:
    tests:
        name: test Python ${{ matrix.python-version }} on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest ]
                python-version: [ 3.6, 3.7, 3.8 ]
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v2
            -   name: Install Python
                uses: actions/setup-python@v2
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Restore cached dependencies
                uses: actions/cache@v2
                with:
                    path: ~/.cache/pip
                    key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('setup.py') }}
                    restore-keys: ${{ runner.os }}-pip-${{ matrix.python-version }}-
            -   name: Install dependencies
                run: |
                    pip install dunamai wheel
                    pip install -e .[dev]
            -   name: Lint with flake8
                run: |
                    # stop the build if there are Python syntax errors or undefined names
                    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                    # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
                    flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
            # TODO figure out why PostGIS container is broken
            #- name: Install PostGreSQL with PostGIS
            #uses: huaxk/postgis-action@v1
            #with:
            #  postgresql version: '11'
            #  postgresql db: test_database
            #  postgresql user: test_user
            #  postgresql password: test_password
            -   name: Test with coverage
                #env:
                #  APRS_FI_API_KEY: ${{ secrets.APRS_FI_API_KEY }}
                #  POSTGRES_HOSTNAME: localhost
                #  POSTGRES_DATABASE: test_database
                #  POSTGRES_USERNAME: test_user
                #  POSTGRES_PASSWORD: test_password
                run: coverage run --source packetraven -m nose --nologcapture --verbose --ignore-files="test_connections\.py"
            -   name: Generate coverage report
                run: coverage report -m
